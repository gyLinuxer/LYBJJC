<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>标签树管理</title>
</head>
<body class="container-full">
<div class="col-sm-12" style="">
    <div class="alert alert-success" role="alert"><strong>提示：</strong>本页面用来对系统内的标签树进行管理。</div>
</div>
{neq name="Warning" value=""}
<div class="form-group">
    <div class="col-sm-12">
        <div class="alert alert-danger" role="alert"><strong>提示：</strong>{$Warning}</div>
    </div>
</div>
{/neq}
<form action="/SafetyMng/TreeMng/AddTree.html" method="post" enctype="application/x-www-form-urlencoded">
    <div class="row">
        <div class="col-sm-4" style="border-right: dashed 1px;min-height: 800px;">
            <div class="row">
                <div class="col-xs-3"><label class="control-label" for="TreeName">标签树名称:</label></div>
                <div class="col-xs-6"><input id="TreeName" name="TreeName" class="form-control"/></div>
                <div class="col-xs-3"><button type="submit" class="btn btn-sm btn-success" AddTree>增加</button></div>
            </div>
            <h4 style="text-align: center;margin-top: 20px;color: #ac2925;">数据库中的标签树列表</h4>
            <div class="list-group">
                {volist name="TreeList" id = "vo"}
                    <a href="#" class="list-group-item" Tree NodeCode = "{$vo.NodeCode}">{$vo.NodeName}</a>
                {/volist}
            </div>

        </div>
        <div class="col-sm-8" >
            <div class="row">
                <div class="col-xs-1" style="width: 100px;"><label class="control-label" for="TreeName">节点搜索:</label></div>
                <div class="col-xs-4"><input id="NodeName"  class="form-control"/></div>
            </div>
            <ul id="tree" class="ztree" style="margin-top: 20px;">

            </ul>
        </div>
        <div id="showDiv" style="display: none;">
            <div class="row" style="margin-top: 20px;">
                <div class="col-xs-2">节点名称:</div>
                <div class="col-xs-8"><input id="NewNodeName" class="form-control "/></div>
            </div>
        </div>
    </div>
</form>
<script>



    var setting = {
        view: {
            addHoverDom: addHoverDom,
            removeHoverDom: removeHoverDom,
        },
        edit: {
            enable: true,
            editNameSelectAll: true,
            showRemoveBtn: showRemoveBtn,
            showRenameBtn: true
        },
        data: {
            //这个是关键不然页面不会显示
            simpleData: {
                enable: true,
                idkey: "id",
                pidKey: "pId",
                name:'name',
            }
        },
        callback: {
            beforeDrag: beforeDrag,
            beforeEditName: beforeEditName,
            beforeRemove: beforeRemove,
            beforeRename: beforeRename,
            onRemove: onRemove,
            onRename: onRename
        }
    };

    var log, className = "dark";
    function beforeDrag(treeId, treeNodes) {
        return false;
    }
    function beforeEditName(treeId, treeNode) {
       /* className = (className === "dark" ? "":"dark");
       // showLog("[ "+getTime()+" beforeEditName ]&nbsp;&nbsp;&nbsp;&nbsp; " + treeNode.name);
        var zTree = $.fn.zTree.getZTreeObj("treeDemo");
        zTree.selectNode(treeNode);
        setTimeout(function() {
            if (confirm("进入节点 -- " + treeNode.name + " 的编辑状态吗？")) {
                setTimeout(function() {
                    zTree.editName(treeNode);
                }, 0);
            }
        }, 0);*/
        return true;
    }
    function beforeRemove(treeId, treeNode) {
        layer.confirm('确定删除节点-->'+treeNode.name+'?', {
            btn: ['确定', '取消'] //可以无限个按钮
        }, function(index, layero){
            if(treeNode.isParent){
                layer.alert('父节点不允许被删除!');
            }else{
                $o =  {'NodeCode':treeNode.id};
                $.ajax({
                    url:"/SafetyMng/TreeMng/DelTreeNode",
                    data: JSON.stringify($o),
                    type:'post',
                    dataType:"json",
                    success:function (data,textStatus) {
                        if(data['Ret']=='success'){
                            var zTree = $.fn.zTree.getZTreeObj("tree");
                            zTree.removeNode(treeNode,false);
                            layer.close(index);
                        }else{
                            layer.alert('删除节点失败:'+data['msg']);
                        }
                    },
                    error:function (XMLHttpRequest,textStatus,errorThrown) {
                        layer.alert('XMLHttpRequest失败!');
                    }
                });
            }
        }, function(index){


        });

       return false;

    }
    function onRemove(e, treeId, treeNode) {
        alert('remove');
        //alert(treeNode.id);
        //return false;
       // showLog("[ "+getTime()+" onRemove ]&nbsp;&nbsp;&nbsp;&nbsp; " + treeNode.name);
        return false;
    }
    function beforeRename(treeId, treeNode, newName, isCancel) {
       /* className = (className === "dark" ? "":"dark");
         if (newName.length == 0) {
            setTimeout(function() {
                var zTree = $.fn.zTree.getZTreeObj("treeDemo");
                zTree.cancelEditName();
                alert("节点名称不能为空.");
            }, 0);
            return false;
        }*/
        return confirm("确认重命名 节点 -- " + treeNode.name + " 吗？");
    }
    function onRename(e, treeId, treeNode, isCancel) {
        alert(treeNode.id);
       // showLog((isCancel ? "<span style='color:red'>":"") + "[ "+getTime()+" onRename ]&nbsp;&nbsp;&nbsp;&nbsp; " + treeNode.name + (isCancel ? "</span>":""));
    }
    function showRemoveBtn(treeId, treeNode) {
        return  !treeNode.isParent;
    }
    function showRenameBtn(treeId, treeNode) {
        return !treeNode.isLastNode;
    }

    function getTime() {
        var now= new Date(),
            h=now.getHours(),
            m=now.getMinutes(),
            s=now.getSeconds(),
            ms=now.getMilliseconds();
        return (h+":"+m+":"+s+ " " +ms);
    }

    function gyAddNode() {
        
    }
    
    var newCount = 1;
    function addHoverDom(treeId, treeNode) {
        var sObj = $("#" + treeNode.tId + "_span");
        if (treeNode.editNameFlag || $("#addBtn_"+treeNode.tId).length>0) return;
        var addStr = "<span class='button add' id='addBtn_" + treeNode.tId
            + "' title='add node' onfocus='this.blur();'></span>";
        sObj.after(addStr);
        var btn = $("#addBtn_"+treeNode.tId);
        if (btn) btn.bind("click", function(){
            layer.prompt({title: '请输入节点名称:', formType: 0}, function(NodeName, index){
                $o =  {'ParentCode':treeNode.id,'NewNodeName':NodeName};
                $.ajax({
                    url:"/SafetyMng/TreeMng/AddTreeNode",
                    data: JSON.stringify($o),
                    type:'post',
                    dataType:"json",
                    success:function (data,textStatus) {
                        if(data['Ret']=='success'){
                            var zTree = $.fn.zTree.getZTreeObj("tree");
                            zTree.addNodes(treeNode, {id:data['NodeCode'], pId:data['ParentNodeCode'], name:data['NodeName']});
                            layer.close(index);
                        }else{
                            layer.alert('添加节点失败:'+data['msg']);
                        }
                    },
                    error:function (XMLHttpRequest,textStatus,errorThrown) {
                        layer.alert('XMLHttpRequest失败!');
                    }
                });
            });
        });
    };
    function removeHoverDom(treeId, treeNode) {
        $("#addBtn_"+treeNode.tId).unbind().remove();
    };
    function selectAll() {
        var zTree = $.fn.zTree.getZTreeObj("treeDemo");
        zTree.setting.edit.editNameSelectAll =  $("#selectAll").attr("checked");
    }



   var nodes  = [];

    function TreeInit() {
        $.fn.zTree.init($("#tree"), setting, nodes);
        fuzzySearch('tree','#NodeName',null,true); //初始化模糊搜索方法
    }

    $(function () {
        $('a[Tree]').click(function () {
            $('a[Tree]').removeClass('active');
            $(this).addClass('active');

            $o =  {'TreeCode':$(this).attr('NodeCode')};
            $.ajax({
                url:"/SafetyMng/TreeMng/GetTreeNodeJsonData",
                data: JSON.stringify($o),
                type:'post',
                dataType:"json",
                success:function (data,textStatus) {
                    if(data['Ret']=='Success'){
                        nodes = data['data'];
                        TreeInit();
                    }else{
                        layer.alert('获取树节点数据失败!');
                    }
                },
                error:function (XMLHttpRequest,textStatus,errorThrown) {
                    layer.alert('设置状态失败!');
                }
            });

        });
    });
</script>
</body>
</html>